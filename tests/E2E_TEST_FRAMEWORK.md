# End-to-End Integration Testing Framework

**Issue:** #324 - End-to-End Integration Testing Framework

## Overview

This testing framework provides comprehensive validation of the ModPorter AI conversion pipeline from Java mods to Bedrock add-ons. The tests ensure that the complete workflow (JAR → Analysis → Build → Package) produces valid, working .mcaddon files.

## Test Structure

### Main Test File: `ai-engine/tests/test_mvp_conversion.py`

This comprehensive test suite includes:

#### Test Case 1: Simple Block Conversion (Happy Path)
- **Purpose**: Validate the complete MVP pipeline
- **Steps**:
  1. Load test JAR (simple_copper_block.jar)
  2. Run JavaAnalyzerAgent to extract registry name and texture
  3. Run BedrockBuilderAgent to generate behavior and resource packs
  4. Run PackagingAgent to create .mcaddon file
  5. Validate .mcaddon structure per Bedrock specification
  6. Extract and verify manifest.json files
  7. Verify block definition JSON
  8. Confirm texture present and valid
- **Expected Results**:
  - Analysis succeeds with registry name: `simple_copper:polished_copper`
  - Build creates valid behavior_pack/ and resource_pack/ directories
  - Package creates valid .mcaddon file with correct structure
  - Conversion completes in <30 seconds
- **Success Criteria**:
  - All Bedrock specifications are met
  - No false positives (tests pass but addon doesn't work)

#### Test Case 2: Missing Texture (Fallback)
- **Purpose**: Test conversion when texture is missing
- **Expected Results**:
  - Analysis succeeds but with warning about missing texture
  - Build uses default/fallback texture
  - Package still creates valid .mcaddon
  - Warning is properly documented

#### Test Case 3: Malformed JAR (Error Handling)
- **Purpose**: Test error handling for malformed JAR files
- **Test Scenarios**:
  - Non-existent file path
  - File that's not a valid JAR
  - Empty JAR file
  - Corrupted ZIP file
  - JAR with no mod metadata
- **Expected Results**:
  - Analysis fails gracefully with clear error message
  - No crashes or exceptions
  - Error message is descriptive

#### Test Case 4: Multiple Block Types
- **Purpose**: Test conversion with different block types
- **Test Scenarios**:
  - Solid block (stone-like)
  - Transparent block (glass-like)
  - Custom model block
- **Expected Results**:
  - All block types convert successfully
  - Each has appropriate properties
  - .mcaddon contains all blocks

#### Test Case 5: Manual Bedrock Testing Documentation
- **Purpose**: Generate .mcaddon and document manual testing steps
- **Output**:
  - Generated .mcaddon file
  - Manual testing instructions
  - Expected block properties
  - In-game verification checklist

#### Test Case 6: Performance Benchmarks
- **Purpose**: Validate conversion performance
- **Success Criteria**:
  - Single block conversion: <5 seconds
  - Analysis: <2 seconds
  - Build: <2 seconds
  - Package: <1 second

#### Test Case 7: Coverage Validation
- **Purpose**: Ensure >80% test coverage for conversion pipeline
- **Components Validated**:
  - JavaAnalyzerAgent.analyze_jar_for_mvp
  - BedrockBuilderAgent.build_block_addon_mvp
  - PackagingAgent.build_mcaddon_mvp
  - Error handling paths
  - Edge cases

## Test Fixtures

### `simple_copper_block.jar`

Located at: `tests/fixtures/simple_copper_block.jar`

**Generated by**: `tests/fixtures/simple_copper_block.py`

**Contents**:
- `fabric.mod.json` - Mod metadata
- `assets/simple_copper/textures/block/polished_copper.png` - Block texture
- `com/example/simple_copper/PolishedCopperBlock.java` - Java source
- `com/example/simple_copper/PolishedCopperBlock.class` - Compiled class
- `com/example/simple_copper/SimpleCopperMod.java` - Main mod class
- `META-INF/MANIFEST.MF` - JAR manifest
- `simple_copper.mixins.json` - Mixins configuration
- `pack.mcmeta` - Pack metadata

**Expected Analysis Results**:
```json
{
  "success": true,
  "registry_name": "simple_copper:polished_copper",
  "texture_path": "assets/simple_copper/textures/block/polished_copper.png",
  "errors": []
}
```

### `JarGenerator` Utility

Located at: `tests/fixtures/test_jar_generator.py`

**Methods**:
- `create_simple_jar(name, java_files)` - Create a basic JAR with custom files
- `create_mod_jar(mod_name, blocks, items)` - Create a realistic test mod JAR
- `create_test_mod_suite(output_dir)` - Create multiple test mods

**Usage**:
```python
from tests.fixtures.test_jar_generator import JarGenerator

generator = JarGenerator(temp_dir)
jar_path = generator.create_mod_jar("test_mod", blocks=["stone_block"])
```

## Running Tests

### Prerequisites

Install dependencies:
```bash
cd ai-engine
pip install -r requirements.txt
pip install -r requirements-dev.txt
```

### Run All E2E Tests

```bash
cd ai-engine
python -m pytest tests/test_mvp_conversion.py -v -s
```

### Run Specific Test

```bash
cd ai-engine
python -m pytest tests/test_mvp_conversion.py::TestMVPEndToEndConversion::test_simple_block_conversion -v -s
```

### Run Edge Case Tests

```bash
cd ai-engine
python -m pytest tests/test_mvp_conversion.py::TestMVPEdgeCases -v -s
```

### Run with Coverage

```bash
cd ai-engine
python -m pytest tests/test_mvp_conversion.py --cov=agents --cov-report=html
```

## Expected Output

### Successful Test Run

```
======================================================================
TEST: Simple Block Conversion (Happy Path)
======================================================================

[Step 1/4] Analyzing JAR file...
  ✓ Analysis completed in 0.45s
  Registry name: simple_copper:polished_copper
  Texture path: assets/simple_copper/textures/block/polished_copper.png

[Step 2/4] Building Bedrock add-on...
  ✓ Build completed in 1.23s
  Behavior pack: /tmp/.../behavior_pack
  Resource pack: /tmp/.../resource_pack
  Found 1 texture file(s)

[Step 3/4] Packaging .mcaddon file...
  ✓ Package completed in 0.15s
  Output: /tmp/.../simple_copper_polished_copper.mcaddon
  File size: 4,521 bytes

[Step 4/4] Validating .mcaddon file...
  File count: 12
  Valid ZIP: True
  Has behavior pack: True
  Has resource pack: True
  Manifest count: 2

======================================================================
✅ TEST PASSED: Simple Block Conversion
======================================================================
Total time: 2.87s
  Analysis: 0.45s
  Build: 1.23s
  Package: 0.15s
```

## Bedrock Specification Validation

The tests validate the following Bedrock add-on specifications:

### .mcaddon Structure

```
simple_copper_polished_copper.mcaddon
├── behavior_packs/
│   └── simple_copper_bp/
│       ├── manifest.json
│       └── blocks/
│           └── polished_copper.json
└── resource_packs/
    └── simple_copper_rp/
        ├── manifest.json
        └── textures/
            └── blocks/
                └── polished_copper.png
```

### Manifest Requirements

**Behavior Pack**:
```json
{
  "format_version": 2,
  "header": {
    "name": "simple_copper_bp",
    "description": "Simple Copper Behavior Pack",
    "uuid": "12345678-1234-1234-1234-123456789abc",
    "version": [1, 0, 0],
    "min_engine_version": [1, 19, 0]
  },
  "modules": [
    {
      "type": "data",
      "uuid": "...",
      "version": [1, 0, 0]
    }
  ]
}
```

**Resource Pack**:
```json
{
  "format_version": 2,
  "header": {
    "name": "simple_copper_rp",
    "description": "Simple Copper Resource Pack",
    "uuid": "87654321-4321-4321-4321-abcdef123456",
    "version": [1, 0, 0],
    "min_engine_version": [1, 19, 0]
  },
  "modules": [
    {
      "type": "resources",
      "uuid": "...",
      "version": [1, 0, 0]
    }
  ]
}
```

### Block Definition Requirements

```json
{
  "format_version": "1.16.100",
  "minecraft:block": {
    "description": {
      "identifier": "simple_copper:polished_copper"
    },
    "components": {
      "minecraft:destroy_time": 3.0,
      "minecraft:explosion_resistance": 6.0,
      "minecraft:material_instances": {
        "*": {
          "texture": "polished_copper"
        }
      }
    }
  }
}
```

## Manual Testing in Bedrock Edition

### Steps to Verify Converted Add-on

1. **Generate .mcaddon file**
   ```bash
   cd ai-engine
   python -m pytest tests/test_mvp_conversion.py::TestMVPEndToEndConversion::test_converted_addon_loads_in_bedrock -v -s
   ```

2. **Locate generated file**
   - Test output will show the path
   - Example: `/tmp/.../simple_copper_polished_copper.mcaddon`

3. **Install in Bedrock Edition**
   - Windows 10: Copy to `%localappdata%\Packages\Microsoft.MinecraftUWP_8wekyb3d8bbwe\LocalState\games\com.mojang\development_behavior_packs`
   - Or use Minecraft: Settings → Behavior Packs → Import

4. **Create test world**
   - Create new world with Experimental Features enabled
   - Enable the add-on in world settings

5. **Verify in-game**
   - ✓ Block appears in creative inventory
   - ✓ Block places correctly
   - ✓ Block breaks correctly
   - ✓ Texture displays (no purple checkerboard)
   - ✓ Sound effects are appropriate
   - ✓ Block has correct hardness

## CI/CD Integration

### GitHub Actions Workflow

Add to `.github/workflows/e2e-tests.yml`:

```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          cd ai-engine
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      - name: Run E2E tests
        run: |
          cd ai-engine
          python -m pytest tests/test_mvp_conversion.py -v -s
```

## Success Metrics

### Coverage Targets

- **Overall Coverage**: >80% for conversion pipeline
- **Critical Path Coverage**: 100%
  - JavaAnalyzerAgent.analyze_jar_for_mvp
  - BedrockBuilderAgent.build_block_addon_mvp
  - PackagingAgent.build_mcaddon_mvp

### Performance Targets

- **Single Block Conversion**: <5 seconds
  - Analysis: <2 seconds
  - Build: <2 seconds
  - Package: <1 second
- **Total Pipeline**: <30 seconds for typical mod

### Quality Metrics

- **Zero False Positives**: All tests that pass produce working add-ons
- **Zero Crashes**: No unhandled exceptions
- **Clear Error Messages**: All failures have descriptive messages

## Troubleshooting

### Common Issues

**Issue**: `ModuleNotFoundError: No module named 'crewai'`
- **Solution**: Install ai-engine dependencies
  ```bash
  cd ai-engine
  pip install -r requirements.txt
  ```

**Issue**: `Test fixture not found: simple_copper_block.jar`
- **Solution**: Generate the test fixture
  ```bash
  python tests/fixtures/simple_copper_block.py
  ```

**Issue**: Conversion takes >30 seconds
- **Solution**: Check for resource contention or disk I/O issues
- **Note**: CI environments may be slower, adjust timeout accordingly

**Issue**: Tests pass but add-on doesn't work in Bedrock
- **Solution**: This is a false positive - report as bug
- **Check**: Manual testing documentation for verification steps

## Extending the Framework

### Adding New Test Cases

1. Create test method in `TestMVPEndToEndConversion` or `TestMVPEdgeCases`
2. Follow naming convention: `test_<scenario>_<condition>`
3. Add docstring explaining purpose and expected results
4. Use existing fixtures or create new ones
5. Validate all assertions
6. Add to coverage tracking

### Creating New Fixtures

1. Add generator function to `tests/fixtures/`
2. Document expected structure and properties
3. Generate fixture JAR
4. Commit to repository or generate in setup
5. Update documentation

## Related Issues

- #324: End-to-End Integration Testing Framework
- #174: Add sample .jar fixture for testing
- #167: Implement MVP analysis method
- #168: Implement MVP build method

## References

- [Bedrock Documentation](https://wiki.bedrock.dev/)
- [Minecraft Add-on Packaging](https://learn.microsoft.com/en-us/minecraft/creator/documents/reference/guides/addonpackaging)
- [Project CLAUDE.md](../../CLAUDE.md)
