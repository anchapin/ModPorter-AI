# Alert Rules for ModPorter AI
# Issue: #457 - Monitoring Dashboards with Grafana/Prometheus (Phase 3)

groups:
  - name: modporter_conversion_alerts
    interval: 30s
    rules:
      # Conversion success rate alert
      - alert: ConversionSuccessRateLow
        expr: modporter_conversion_success_rate < 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Conversion success rate is below 80%"
          description: "Current success rate: {{ $value | printf \"%.1f\" }}%"

      # High error rate alert
      - alert: HighConversionErrorRate
        expr: rate(modporter_conversion_jobs_total{status="failed"}[5m]) > 0.1
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "High conversion error rate detected"
          description: "Error rate is {{ $value | printf \"%.2f\" }} per second"

      # Conversion timeout alert
      - alert: ConversionTimeout
        expr: modporter_conversion_duration_seconds > 180
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Conversion taking too long"
          description: "Conversion duration exceeds 3 minutes"

  - name: modporter_performance_alerts
    interval: 30s
    rules:
      # API response time alert
      - alert: HighAPIResponseTime
        expr: histogram_quantile(0.95, rate(modporter_http_request_duration_seconds_bucket[5m])) > 0.2
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "API response time (p95) is above 200ms"
          description: "Current p95 response time: {{ $value | printf \"%.3f\" }}s"

      # Queue size alert
      - alert: ConversionQueueBacklog
        expr: modporter_conversion_queue_size > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Conversion queue has a large backlog"
          description: "Queue size: {{ $value }}"

  - name: modporter_llm_alerts
    interval: 60s
    rules:
      # High LLM cost alert (converted to hourly rate)
      - alert: HighLLMCost
        expr: rate(modporter_llm_cost_dollars[1h]) * 3600 > 10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High LLM API cost detected"
          description: "Current cost rate: ${{ $value | printf \"%.2f\" }}/hour"

      # Token usage alert (converted to per-minute rate)
      - alert: HighTokenUsage
        expr: rate(modporter_llm_tokens_total[5m]) * 60 > 100000
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "High token usage detected"
          description: "Token usage rate: {{ $value | printf \"%.0f\" }}/min"

  - name: modporter_system_alerts
    interval: 30s
    rules:
      # Active conversions limit
      - alert: TooManyActiveConversions
        expr: modporter_active_conversions > 10
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Too many active conversions"
          description: "Active conversions: {{ $value }}"

      # Database performance
      - alert: HighDatabaseLatency
        expr: histogram_quantile(0.95, rate(modporter_db_operation_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High database latency detected"
          description: "DB p95 latency: {{ $value | printf \"%.3f\" }}s"

      # Cache hit rate (multiplied by 100 for percentage)
      - alert: LowCacheHitRate
        expr: (rate(modporter_cache_operations_total{operation="hit"}[5m]) / rate(modporter_cache_operations_total[5m])) * 100 < 50
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate: {{ $value | printf \"%.1f\" }}%"
