name: CI - Act Local Testing

on:
  # This workflow is intended for local testing with 'act' and should not run on GitHub
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for triggering workflow"
        required: false
        default: "Manual trigger for testing"

env:
  PYTHON_VERSION: "3.11"

jobs:
  # Simple job for testing with act
  act-test:
    name: Act Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        test-suite: ["integration", "backend", "ai-engine"]
        include:
          - test-suite: integration
            test-path: "ai-engine/tests/integration/test_basic_integration.py"
          - test-suite: backend
            test-path: "backend/tests/integration/"
          - test-suite: ai-engine
            test-path: "ai-engine/tests/integration/test_imports.py"

    # Simplified container setup for act
    container:
      image: catthehacker/ubuntu:act-latest
      options: --user root

    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
        ports:
          - 16380:6379

      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_DB: modporter
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd "pg_isready -U postgres -d modporter"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 15432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          echo "üîß Installing system dependencies..."
          apt-get update -qq
          apt-get install -y -qq curl netcat-openbsd ffmpeg libmagic1

      - name: Install Python dependencies
        run: |
          echo "üêç Installing Python dependencies..."
          python -m pip install --upgrade pip

          # Install common test dependencies
          pip install pytest pytest-asyncio pytest-cov pytest-timeout

          case "${{ matrix.test-suite }}" in
            "ai-engine"|"integration")
              echo "Installing AI Engine dependencies..."
              cd ai-engine
              pip install -r requirements.txt
              pip install -r requirements-dev.txt 2>/dev/null || echo "No requirements-dev.txt found"
              ;;
            "backend")
              echo "Installing Backend dependencies..."
              cd backend
              pip install -r requirements.txt
              pip install -r requirements-dev.txt 2>/dev/null || echo "No requirements-dev.txt found"
              ;;
          esac

      - name: Wait for services
        run: |
          echo "‚è≥ Waiting for services..."
          timeout 30 bash -c 'until nc -z redis 6379; do sleep 1; done'
          timeout 30 bash -c 'until nc -z postgres 5432; do sleep 1; done'
          echo "‚úÖ Services are ready!"

      - name: Run tests
        run: |
          echo "üß™ Running ${{ matrix.test-suite }} tests..."

          case "${{ matrix.test-suite }}" in
            "integration")
              cd ai-engine
              python -m pytest tests/integration/test_basic_integration.py -v --tb=short
              ;;
            "backend")
              cd backend
              python -m pytest tests/integration/ -v --tb=short || echo "Some tests failed, but continuing..."
              ;;
            "ai-engine")
              cd ai-engine
              python -m pytest tests/integration/test_imports.py -v --tb=short
              ;;
          esac
        env:
          REDIS_URL: redis://redis:6379
          DATABASE_URL: postgresql+asyncpg://postgres:password@postgres:5432/modporter
          PYTHONPATH: ${{ github.workspace }}
          TESTING: "true"

      - name: Simple health check
        run: |
          echo "üè• Running health checks..."
          python -c "import sys; print('Python:', sys.version)"
          echo "Redis test: $(redis-cli -h redis -p 6379 ping || echo 'Redis not available')"
          echo "Postgres test: $(pg_isready -h postgres -p 5432 -U postgres || echo 'Postgres not available')"