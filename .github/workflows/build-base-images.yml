name: Build Base Images

on:
  schedule:
    # Rebuild base images weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all base images'
        required: false
        default: 'false'
        type: boolean
  push:
    paths:
      - '**/requirements*.txt'
      - '**/package.json'
      - 'pnpm-lock.yaml'
      - 'docker/base-images/**'

env:
  REGISTRY: ghcr.io
  CACHE_VERSION: v2

jobs:
  build-python-base:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Free up disk space
      run: |
        echo "ðŸ§¹ Cleaning up disk space before Docker build"
        echo "Initial disk usage:"
        df -h
        
        # Remove unnecessary packages and files
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        
        # Clean Docker cache if exists
        docker system prune -af --volumes || true
        
        # Clean package manager caches
        sudo apt-get clean
        sudo apt-get autoremove -y
        
        # Remove large directories we don't need
        sudo rm -rf /usr/share/doc
        sudo rm -rf /usr/share/man
        
        echo "Disk usage after cleanup:"
        df -h
    
    - name: Checkout repository
      uses: actions/checkout@v5
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set repository name to lowercase
      id: repo-name
      run: |
        echo "lowercase=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
    
    - name: Extract Python dependencies hash
      id: deps-hash
      run: |
        # Create combined hash of all Python requirements
        HASH=$(cat ai-engine/requirements.txt backend/requirements.txt | sha256sum | cut -d' ' -f1 | head -c16)
        echo "hash=$HASH" >> $GITHUB_OUTPUT
        echo "Python deps hash: $HASH"
    
    - name: Check if base image exists
      id: check-image
      run: |
        IMAGE_TAG="${{ env.REGISTRY }}/${{ steps.repo-name.outputs.lowercase }}/python-base:${{ steps.deps-hash.outputs.hash }}"
        if docker buildx imagetools inspect "$IMAGE_TAG" > /dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Base image already exists: $IMAGE_TAG"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Base image needs to be built: $IMAGE_TAG"
        fi
    
    - name: Build and push Python base image
      if: steps.check-image.outputs.exists == 'false' || github.event.inputs.force_rebuild == 'true'
      uses: docker/build-push-action@v6
      with:
        context: .
        file: docker/base-images/Dockerfile.python-base
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ steps.repo-name.outputs.lowercase }}/python-base:${{ steps.deps-hash.outputs.hash }}
          ${{ env.REGISTRY }}/${{ steps.repo-name.outputs.lowercase }}/python-base:latest
        cache-from: type=gha,scope=python-base-${{ env.CACHE_VERSION }}
        cache-to: type=gha,mode=max,scope=python-base-${{ env.CACHE_VERSION }}
        platforms: linux/amd64
        build-args: |
          BUILDKIT_INLINE_CACHE=1
          DOCKER_BUILDKIT=1
        no-cache: ${{ github.event.inputs.force_rebuild == 'true' }}

  build-node-base:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Free up disk space
      run: |
        echo "ðŸ§¹ Cleaning up disk space before Docker build"
        echo "Initial disk usage:"
        df -h
        
        # Remove unnecessary packages and files
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        
        # Clean Docker cache if exists
        docker system prune -af --volumes || true
        
        # Clean package manager caches
        sudo apt-get clean
        sudo apt-get autoremove -y
        
        # Remove large directories we don't need
        sudo rm -rf /usr/share/doc
        sudo rm -rf /usr/share/man
        
        echo "Disk usage after cleanup:"
        df -h
    
    - name: Checkout repository
      uses: actions/checkout@v5
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set repository name to lowercase
      id: repo-name
      run: |
        echo "lowercase=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
    
    - name: Extract Node dependencies hash
      id: deps-hash
      run: |
        HASH=$(sha256sum pnpm-lock.yaml | cut -d' ' -f1 | head -c16)
        echo "hash=$HASH" >> $GITHUB_OUTPUT
        echo "Node deps hash: $HASH"
    
    - name: Check if base image exists
      id: check-image
      run: |
        IMAGE_TAG="${{ env.REGISTRY }}/${{ steps.repo-name.outputs.lowercase }}/node-base:${{ steps.deps-hash.outputs.hash }}"
        if docker buildx imagetools inspect "$IMAGE_TAG" > /dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Build and push Node base image
      if: steps.check-image.outputs.exists == 'false' || github.event.inputs.force_rebuild == 'true'
      uses: docker/build-push-action@v6
      with:
        context: .
        file: docker/base-images/Dockerfile.node-base
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ steps.repo-name.outputs.lowercase }}/node-base:${{ steps.deps-hash.outputs.hash }}
          ${{ env.REGISTRY }}/${{ steps.repo-name.outputs.lowercase }}/node-base:latest
        cache-from: type=gha,scope=node-base-${{ env.CACHE_VERSION }}
        cache-to: type=gha,mode=max,scope=node-base-${{ env.CACHE_VERSION }}
        platforms: linux/amd64
        build-args: |
          BUILDKIT_INLINE_CACHE=1
          DOCKER_BUILDKIT=1
        no-cache: ${{ github.event.inputs.force_rebuild == 'true' }}
